import { GoogleGenAI, Modality, Type, Chat } from "@google/genai";
import { WorkoutPlan, ChatMessage } from "../types";

// NOTE: In a real production app, never expose keys on the client.
// This requires a proxy server. For this demo, we assume process.env.API_KEY is available.
const apiKey = process.env.API_KEY || ''; 
const ai = new GoogleGenAI({ apiKey });

/**
 * Helper to decode base64 audio for playback
 */
const decodeAudioData = async (
  base64Data: string,
  ctx: AudioContext
): Promise<AudioBuffer> => {
  const binaryString = atob(base64Data);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  
  const dataInt16 = new Int16Array(bytes.buffer);
  const frameCount = dataInt16.length;
  const buffer = ctx.createBuffer(1, frameCount, 24000); // 24kHz is standard for some Gemini TTS models
  const channelData = buffer.getChannelData(0);
  
  for (let i = 0; i < frameCount; i++) {
    channelData[i] = dataInt16[i] / 32768.0;
  }
  
  return buffer;
};

export const GeminiService = {
  /**
   * Generates a daily quote and a joke.
   */
  async getDailyContent(): Promise<{ quote: string; joke: string }> {
    try {
      const model = "gemini-2.5-flash";
      const response = await ai.models.generateContent({
        model,
        contents: "Generate a motivational health quote and a refreshing short clean joke.",
        config: {
            responseMimeType: "application/json",
            responseSchema: {
                type: Type.OBJECT,
                properties: {
                    quote: { type: Type.STRING },
                    joke: { type: Type.STRING }
                }
            }
        }
      });
      const text = response.text || "{}";
      return JSON.parse(text);
    } catch (error) {
      console.error("Gemini Quote Error:", error);
      return { quote: "Health is wealth.", joke: "Why did the gym close? It just didn't work out!" };
    }
  },

  /**
   * Generates soothing audio speech for mental grounding.
   */
  async getSoothingVoice(userText: string): Promise<AudioBuffer | null> {
    try {
      const model = "gemini-2.5-flash-preview-tts";
      const response = await ai.models.generateContent({
        model,
        contents: `Speak in a very calm, soothing, therapeutic voice. Address this user concern safely and supportively: "${userText}". Keep it under 30 seconds.`,
        config: {
          responseModalities: [Modality.AUDIO],
          speechConfig: {
            voiceConfig: {
              prebuiltVoiceConfig: { voiceName: 'Kore' }, 
            },
          },
        },
      });

      const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      if (!base64Audio) return null;

      const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
      const audioCtx = new AudioContextClass({ sampleRate: 24000 });
      return await decodeAudioData(base64Audio, audioCtx);

    } catch (error) {
      console.error("Gemini TTS Error:", error);
      return null;
    }
  },

  /**
   * Analyzes text for emotional insights.
   */
  async analyzeMoodInsight(text: string): Promise<{ sentiment: string; tone: string; themes: string[]; insight: string } | null> {
    try {
      const model = "gemini-2.5-flash";
      const response = await ai.models.generateContent({
        model,
        contents: `Analyze this user's reflection for mental wellness insights. User text: "${text}".
        Return JSON with:
        - sentiment: (Positive, Neutral, Negative, Mixed)
        - tone: 1-2 words describing the emotional tone (e.g., Anxious, Hopeful)
        - themes: Array of 1-3 key topics found
        - insight: A supportive, psychological observation or suggestion (max 2 sentences).`,
        config: {
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              sentiment: { type: Type.STRING },
              tone: { type: Type.STRING },
              themes: { type: Type.ARRAY, items: { type: Type.STRING } },
              insight: { type: Type.STRING },
            },
          },
        },
      });
      return JSON.parse(response.text || "{}");
    } catch (error) {
      console.error("Gemini Analysis Error:", error);
      return null;
    }
  },

  /**
   * Safe symptom checker using Gemini 3 Pro with Thinking Mode.
   */
  async checkSymptoms(symptoms: string): Promise<string> {
    try {
      // Use Gemini 3 Pro for complex reasoning
      const model = "gemini-3-pro-preview";
      const systemInstruction = "You are HealthGuard, an advanced medical AI assistant. Provide detailed, professional, and empathetic health insights based on the symptoms. Explain potential causes clearly and offer practical care advice. Maintain a supportive and authoritative tone.";
      
      const response = await ai.models.generateContent({
        model,
        contents: symptoms,
        config: {
            systemInstruction,
            // Enable Thinking Mode for deep analysis
            thinkingConfig: { thinkingBudget: 32768 } 
        }
      });
      return response.text || "I'm having trouble connecting. Please consult a doctor.";
    } catch (error) {
      console.error("Gemini Symptom Error:", error);
      return "Service unavailable. Please see a doctor.";
    }
  },

  /**
   * General Chat with AI Assistant using Gemini 3 Pro.
   */
  async chatWithAssistant(history: ChatMessage[], newMessage: string): Promise<string> {
      try {
          const model = "gemini-3-pro-preview";
          
          const systemInstruction = `You are HealthGuard Pro, the intelligent assistant for the SurakshaMitra HealthGuard app.
          
          **App Capabilities & Features:**
          1. **Dashboard**: Tracks daily steps, sleep quality, and 'Suraksha Coins' (rewards). Shows daily quotes/jokes.
          2. **Personality Hub**: A creative quiz that determines a user's unique archetype (e.g., "The Radiant Guardian").
          3. **Mental Wellness**: 
             - **Visual Sanctuary**: Generates calming AI images (e.g. landscapes) to reduce stress.
             - **Mood Analysis**: Analyzes feelings and provides insights (sentiment/tone).
             - **Soothing Voice**: Generates therapeutic audio advice.
             - **Zen Games**: A memory match game to improve focus.
          4. **Physical Wellness**:
             - **Workout Generator**: Creates custom exercise routines (e.g. Abs, Legs) based on user difficulty.
             - **Deep Focus**: A timer mode to block distractions.
          5. **Medical Assistant**:
             - **Symptom Checker**: Uses 'Thinking Mode' for deep reasoning on symptoms.
             - **Medical Scanner**: Analyzes images of Prescriptions (dosage/instructions) and X-Rays (bone structure).
             - **Appointments**: Timeline to schedule and track doctor visits with reminders.
             - **Find Nearby**: Uses Google Maps to locate doctors, pharmacies, and gyms.
          
          **Your Role:**
          - Answer questions about how to use these specific features.
          - Provide general health advice (sleep, diet, exercise).
          - Be concise, warm, professional, and empathetic.
          - If the user asks about a feature (like "How do I scan an X-ray?"), guide them to the Medical Assistant tab -> Scanner.
          `;
          
          const chat: Chat = ai.chats.create({
              model,
              config: { systemInstruction }
          });
          
          // Reconstruct conversation history string to maintain context in this stateless call
          const conversationContext = history.slice(-5).map(h => `${h.role === 'user' ? 'User' : 'Assistant'}: ${h.content}`).join('\n');
          const fullPrompt = history.length > 0 
            ? `Previous Conversation:\n${conversationContext}\n\nCurrent User Question: ${newMessage}` 
            : newMessage;
          
          const result = await chat.sendMessage({ message: fullPrompt });
          return result.text || "I'm listening...";
      } catch (error) {
          console.error("Chat Error:", error);
          return "I'm having trouble connecting right now.";
      }
  },

  /**
   * Analyzes personality quiz answers.
   */
  async analyzePersonality(qa: {question: string, answer: string}[]): Promise<{ archetype: string; emoji: string; traits: string[]; description: string; message: string } | null> {
    try {
        const model = "gemini-3-pro-preview"; // Use powerful model for creative writing
        const prompt = `Analyze these personality quiz answers: ${JSON.stringify(qa)}. 
        Determine a creative, uplifting personality archetype (e.g., "The Cosmic Healer", "The Quantum Architect", "The Serene Warrior").
        Return JSON with:
        {
            "archetype": "Title Name",
            "emoji": "Single Representative Emoji",
            "traits": ["Trait 1", "Trait 2", "Trait 3"],
            "description": "A 2-sentence deep psychological description.",
            "message": "A short, exciting, and empowering message for the user."
        }`;

        const response = await ai.models.generateContent({
            model,
            contents: prompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        archetype: { type: Type.STRING },
                        emoji: { type: Type.STRING },
                        traits: { type: Type.ARRAY, items: { type: Type.STRING } },
                        description: { type: Type.STRING },
                        message: { type: Type.STRING }
                    }
                }
            }
        });
        return JSON.parse(response.text || "{}");
    } catch (error) {
        console.error("Personality Analysis Error:", error);
        return {
            archetype: "The Digital Pioneer",
            emoji: "ðŸš€",
            traits: ["Curious", "Resilient", "Forward-thinking"],
            description: "You are exploring new frontiers of health and technology.",
            message: "Keep pushing boundaries!"
        };
    }
  },

  /**
   * Analyzes prescription image using Gemini 3 Pro.
   */
  async analyzePrescription(base64Image: string): Promise<string> {
    try {
      const model = "gemini-3-pro-preview"; // Upgraded vision model
      const response = await ai.models.generateContent({
        model,
        contents: {
            parts: [
                {
                    inlineData: {
                        mimeType: "image/png", 
                        data: base64Image
                    }
                },
                {
                    text: "Analyze this medical prescription image. Extract and list the medications, specific dosages, frequency, and any special instructions in a clear, structured format."
                }
            ]
        }
      });
      return response.text || "Could not analyze image.";
    } catch (error) {
      console.error("Gemini Vision Error:", error);
      return "Unable to process the image. Please try again.";
    }
  },

  /**
   * Analyzes X-ray image using Gemini 3 Pro.
   */
  async analyzeXray(base64Image: string): Promise<string> {
    try {
      const model = "gemini-3-pro-preview"; // Upgraded vision model
      const response = await ai.models.generateContent({
        model,
        contents: {
            parts: [
                {
                    inlineData: {
                        mimeType: "image/png",
                        data: base64Image
                    }
                },
                {
                    text: "Conduct a detailed technical analysis of this medical X-ray. Identify the anatomical region. Describe the bone structure, alignment, and any visible anomalies or fractures using precise medical terminology. Provide a professional structural observation."
                }
            ]
        }
      });
      return response.text || "Could not analyze X-ray.";
    } catch (error) {
      console.error("Gemini Xray Error:", error);
      return "Unable to process the X-ray image.";
    }
  },

  /**
   * Finds nearby health services using Google Maps Grounding.
   */
  async findNearbyPlaces(query: string, location: {lat: number, lng: number}): Promise<string> {
      try {
          const model = "gemini-2.5-flash"; // Maps works with Flash
          const response = await ai.models.generateContent({
              model,
              contents: `Find ${query} near the provided location.`,
              config: {
                  tools: [{ googleMaps: {} }],
                  toolConfig: {
                      retrievalConfig: {
                          latLng: {
                              latitude: location.lat,
                              longitude: location.lng
                          }
                      }
                  }
              }
          });
          return response.text || "No places found nearby.";
      } catch (error) {
          console.error("Gemini Maps Error:", error);
          return "Unable to access location services at this time.";
      }
  },

  /**
   * Generates a wellness image.
   */
  async generateWellnessImage(prompt: string, aspectRatio: string): Promise<string | null> {
      try {
          const model = "gemini-3-pro-image-preview";
          const response = await ai.models.generateContent({
              model,
              contents: { parts: [{ text: prompt }] },
              config: {
                  imageConfig: {
                      aspectRatio: aspectRatio as any
                  }
              }
          });

          for (const part of response.candidates?.[0]?.content?.parts || []) {
              if (part.inlineData) {
                  return `data:image/png;base64,${part.inlineData.data}`;
              }
          }
          return null;
      } catch (error) {
          console.error("Gemini Image Gen Error:", error);
          return null;
      }
  },

  /**
   * Generates a workout routine.
   */
  async generateWorkout(target: string, difficulty: string): Promise<WorkoutPlan | null> {
    try {
        const model = "gemini-2.5-flash";
        const prompt = `Create a ${difficulty} home workout routine focusing on ${target}. Return JSON.`;
        const response = await ai.models.generateContent({
            model,
            contents: prompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        name: { type: Type.STRING },
                        exercises: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    name: { type: Type.STRING },
                                    sets: { type: Type.NUMBER },
                                    reps: { type: Type.STRING },
                                    description: { type: Type.STRING }
                                }
                            }
                        }
                    }
                }
            }
        });
        
        if (response.text) {
            return JSON.parse(response.text) as WorkoutPlan;
        }
        return null;
    } catch (e) {
        console.error(e);
        return null;
    }
  }
};
